#!/bin/bash

# This program organises a routine of pre sleep activities to facilitate lucid dreaming
# and tries to wake you up between sleep cycles so that you can try to go back to sleep
# while applying a lucid dreaming technique. It also serves as a wakeup alarm clock.

music1=$HOME/music/*Netgame*
meditation_time=5
init_wait=15

function alarm-timer {
    if $debug; then
        echo "skipping timer"
    else
        command alarm-timer "$@"
    fi
}

function espeak {
    echo "$@"
    command espeak -a 50 "$@"
}

while [ $# -gt 0 ]; do
    case $@ in
        --debug)
            debug=true
            shift
            ;;
        *)
            echo "invalid arg"
            exit 1
            ;;
    esac
done

espeak "start"

espeak "$meditation_time minute meditation starts in 10 seconds"
alarm-timer 10
alarm-timer -m 5 --em ""
espeak "meditation complete"

espeak "1 minute lucid mantra"
alarm-timer -m 1

espeak "Do reality check"
alarm-timer 5 --em "" --im ""

espeak "block one starts in $init_wait minutes"
alarm-timer -m "$init_wait" --em "" --im ""

i=0
while true; do
    if [ $i -ge 4 ]; then
        m="block $i over. $((i*90/60)) hours. $(((i*90)%60)) minutes."
        espeak "$m" -s 130
        espeak "Are you sleeping"
        sleep 1
        espeak "Are you sleeping?" -s 150
        sleep 2
        espeak "Are you sleeping?" -s 100
    fi

    if [ $i -ge 4 -a $i -le 6  ]; then
        mpv --vo=null $music1 --end 11.5 --volume 50
    fi

    if [ $i = 6 ]; then
        espeak "Wake up" -s 140
    fi

    if [ $i -ge 7 ]; then
        mpv --vo=null $music1 --volume 55
        for _ in $(seq 5); do
            espeak "Wake up" -s 140
            sleep 3
        done
    fi

    alarm-timer -m 80 --im "" --em ""
    i=$(($i + 1))
done
